# Requirements Document

## Introduction

Данная функциональность добавляет возможность анализа сообщений в Telegram-чате на предмет потенциальных нарушений Уголовного кодекса РФ. Система должна анализировать сообщения в реальном времени, накапливать данные о потенциальных нарушениях и в конце дня предоставлять отчет с пользователями, статьями УК РФ и возможными сроками наказания.

## Requirements

### Requirement 1

**User Story:** Как администратор чата, я хочу получать ежедневные отчеты о потенциальных нарушениях УК РФ в сообщениях участников, чтобы контролировать соблюдение законодательства в чате.

#### Acceptance Criteria

1. WHEN наступает конец дня (например, 23:59 по московскому времени) THEN система SHALL сгенерировать отчет о всех потенциальных нарушениях УК РФ за день
2. WHEN отчет генерируется THEN система SHALL включить список пользователей с их нарушениями, номера статей УК РФ и возможные сроки наказания
3. WHEN отчет готов THEN система SHALL отправить его в чат или администратору

### Requirement 2

**User Story:** Как система анализа, я хочу иметь доступ к актуальной версии УК РФ, чтобы корректно определять нарушения и соответствующие статьи.

#### Acceptance Criteria

1. WHEN система запускается THEN она SHALL проверить актуальность локальной копии УК РФ
2. IF локальная копия устарела или отсутствует THEN система SHALL загрузить актуальную версию УК РФ из официального источника
3. WHEN УК РФ обновляется THEN система SHALL сохранить его в структурированном виде для быстрого поиска
4. WHEN система работает THEN она SHALL проверять обновления УК РФ не реже одного раза в неделю

### Requirement 3

**User Story:** Как система анализа, я хочу эффективно анализировать сообщения на предмет нарушений УК РФ без превышения лимитов контекста LLM, чтобы обеспечить быструю и точную обработку.

#### Acceptance Criteria

1. WHEN поступает новое сообщение THEN система SHALL предварительно классифицировать его на потенциально проблематичное или безопасное
2. IF сообщение классифицировано как потенциально проблематичное THEN система SHALL найти релевантные статьи УК РФ с помощью семантического поиска
3. WHEN релевантные статьи найдены THEN система SHALL отправить в LLM только сообщение и найденные статьи для детального анализа
4. WHEN LLM анализирует сообщение THEN он SHALL определить наличие нарушения, конкретную статью и возможный срок наказания

### Requirement 4

**User Story:** Как пользователь системы, я хочу, чтобы анализ сообщений происходил в реальном времени без заметных задержек, чтобы не влиять на скорость работы чата.

#### Acceptance Criteria

1. WHEN поступает сообщение THEN анализ SHALL завершиться в течение 2 секунд для 95% случаев
2. WHEN система перегружена THEN она SHALL обрабатывать сообщения в очереди без потери данных
3. IF анализ занимает более 5 секунд THEN система SHALL логировать это как предупреждение
4. WHEN система недоступна THEN сообщения SHALL сохраняться для последующего анализа

### Requirement 5

**User Story:** Как разработчик системы, я хочу иметь возможность настраивать чувствительность анализа и типы отслеживаемых нарушений, чтобы адаптировать систему под разные требования.

#### Acceptance Criteria

1. WHEN система настраивается THEN администратор SHALL иметь возможность выбрать категории статей УК РФ для отслеживания
2. WHEN настраивается чувствительность THEN система SHALL поддерживать уровни: низкий, средний, высокий
3. WHEN изменяются настройки THEN они SHALL применяться к новым сообщениям без перезапуска системы
4. WHEN система работает THEN она SHALL логировать все изменения настроек с временными метками

### Requirement 6

**User Story:** Как администратор, я хочу видеть статистику работы системы анализа нарушений УК РФ, чтобы понимать эффективность и нагрузку на систему.

#### Acceptance Criteria

1. WHEN система работает THEN она SHALL собирать метрики: количество проанализированных сообщений, найденных нарушений, время обработки
2. WHEN запрашивается статистика THEN система SHALL предоставить данные за день, неделю, месяц
3. WHEN обнаруживается аномальная активность THEN система SHALL отправить уведомление администратору
4. WHEN система перегружена THEN она SHALL автоматически масштабироваться или уведомить о необходимости увеличения ресурсов

### Requirement 7

**User Story:** Как система анализа, я хочу различать реальные угрозы и намерения от шуток, сарказма и бытовых выражений, чтобы избежать ложных срабатываний и обеспечить точность анализа.

#### Acceptance Criteria

1. WHEN анализируется сообщение с потенциально проблематичным содержанием THEN система SHALL учитывать контекст беседы (предыдущие сообщения)
2. WHEN обнаруживается неоднозначное выражение THEN система SHALL анализировать тон, намерения и серьезность высказывания
3. WHEN выражение может быть интерпретировано как шутка или сарказм THEN система SHALL классифицировать его с низким уровнем угрозы
4. WHEN обнаруживается прямая угроза с конкретными деталями THEN система SHALL классифицировать его с высоким уровнем угрозы
5. WHEN система не уверена в интерпретации THEN она SHALL помечать сообщение для ручной проверки
6. WHEN анализируется контекст THEN система SHALL учитывать культурные особенности и сленг

### Requirement 8

**User Story:** Как администратор, я хочу иметь возможность просматривать и корректировать результаты автоматического анализа, чтобы обеспечить справедливость и точность оценок.

#### Acceptance Criteria

1. WHEN система генерирует отчет THEN каждое нарушение SHALL иметь уровень уверенности (низкий/средний/высокий)
2. WHEN уровень уверенности низкий или средний THEN администратор SHALL иметь возможность пересмотреть решение
3. WHEN администратор корректирует результат THEN система SHALL учесть это для обучения и улучшения точности
4. WHEN возникает спорная ситуация THEN система SHALL предоставить полный контекст для принятия решения

### Requirement 9

**User Story:** Как система анализа, я хочу классифицировать потенциальные нарушения по степени серьезности и вероятности реального правонарушения, чтобы приоритизировать внимание к наиболее опасным случаям.

#### Acceptance Criteria

1. WHEN обнаруживается потенциальное нарушение THEN система SHALL присвоить ему категорию серьезности: НИЗКАЯ/СРЕДНЯЯ/ВЫСОКАЯ/КРИТИЧЕСКАЯ
2. WHEN категория НИЗКАЯ THEN это SHALL быть неоднозначные выражения, возможно шутки (например, "я тебя убью" в игровом контексте)
3. WHEN категория СРЕДНЯЯ THEN это SHALL быть более серьезные высказывания, но без конкретных деталей
4. WHEN категория ВЫСОКАЯ THEN это SHALL быть прямые угрозы с деталями или призывы к противоправным действиям
5. WHEN категория КРИТИЧЕСКАЯ THEN это SHALL быть детальные планы преступлений или экстремистские призывы
6. WHEN генерируется отчет THEN нарушения SHALL быть отсортированы по категориям серьезности

### Requirement 10

**User Story:** Как пользователь чата, я хочу, чтобы мои персональные данные были защищены при анализе сообщений, чтобы обеспечить конфиденциальность.

#### Acceptance Criteria

1. WHEN сообщение анализируется THEN система SHALL обрабатывать только текст сообщения без сохранения метаданных пользователя
2. WHEN данные сохраняются THEN они SHALL быть анонимизированы (хеширование user_id)
3. WHEN генерируется отчет THEN персональные данные SHALL быть доступны только администраторам с соответствующими правами
4. WHEN данные устаревают THEN они SHALL автоматически удаляться через 30 дней