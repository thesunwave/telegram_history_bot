# Requirements Document

## Introduction

Текущая система суммаризации сообщений из Telegram чата имеет критические проблемы производительности и качества:

1. **Проблема множественных KV запросов**: Система делает сотни последовательных запросов к KV хранилищу, что приводит к длительному времени выполнения и превышению лимитов API
2. **Проблема потери контекста в OpenAI**: Батчевая обработка сообщений приводит к потере контекста между частями, что снижает качество итоговой сводки
3. **Неэффективное использование контекста**: OpenAI поддерживает контекст до 128k токенов, но система его не использует эффективно

Необходимо оптимизировать архитектуру для повышения производительности и качества суммаризации.

## Requirements

### Requirement 1: Параллельная загрузка сообщений

**User Story:** Как пользователь системы, я хочу получать сводки быстрее, чтобы не ждать долго при обработке больших объемов сообщений

#### Acceptance Criteria

1. WHEN система запрашивает сообщения из KV THEN она SHALL использовать параллельные воркеры для извлечения данных
2. WHEN система обрабатывает курсоры KV THEN она SHALL распределять работу между несколькими воркерами через Durable Objects
3. WHEN воркеры завершают загрузку THEN система SHALL агрегировать результаты в единый набор сообщений
4. WHEN происходит ошибка в одном воркере THEN система SHALL продолжать работу с остальными воркерами
5. WHEN все воркеры завершают работу THEN система SHALL передать агрегированные сообщения в AI провайдер

### Requirement 2: Оптимизация использования контекста OpenAI

**User Story:** Как пользователь, я хочу получать качественные сводки, которые учитывают весь контекст обсуждения, а не теряют важную информацию при батчевой обработке

#### Acceptance Criteria

1. WHEN система формирует запрос к OpenAI THEN она SHALL максимально использовать доступный контекст (до 128k токенов)
2. WHEN сообщений слишком много для одного запроса THEN система SHALL использовать иерархическую суммаризацию вместо батчевой
3. WHEN система делает предварительную обработку THEN она SHALL использовать упрощенный промпт для промежуточных этапов
4. WHEN система формирует финальную сводку THEN она SHALL использовать полный пользовательский промпт
5. WHEN система превышает лимит токенов THEN она SHALL интеллектуально сокращать контент, сохраняя ключевую информацию

### Requirement 3: Двухэтапная обработка сообщений

**User Story:** Как разработчик системы, я хочу иметь гибкую архитектуру обработки, которая может адаптироваться к разным объемам данных

#### Acceptance Criteria

1. WHEN объем сообщений помещается в один запрос THEN система SHALL использовать прямую суммаризацию
2. WHEN объем сообщений превышает лимит одного запроса THEN система SHALL использовать двухэтапную обработку
3. WHEN выполняется первый этап THEN система SHALL создать промежуточные сводки с упрощенным промптом
4. WHEN выполняется второй этап THEN система SHALL объединить промежуточные сводки в финальную с полным промптом
5. WHEN система определяет стратегию обработки THEN она SHALL учитывать размер контекста и количество токенов

### Requirement 4: Управление конфигурацией обработки

**User Story:** Как администратор системы, я хочу настраивать параметры обработки для оптимизации производительности и качества

#### Acceptance Criteria

1. WHEN система инициализируется THEN она SHALL читать конфигурацию параллельной обработки из переменных окружения
2. WHEN система обрабатывает сообщения THEN она SHALL использовать настраиваемое количество параллельных воркеров
3. WHEN система формирует запросы к AI THEN она SHALL использовать настраиваемые лимиты токенов для разных этапов
4. WHEN система выбирает стратегию обработки THEN она SHALL использовать настраиваемые пороги для переключения между режимами
5. WHEN происходят ошибки THEN система SHALL использовать настраиваемые параметры повторных попыток

### Requirement 5: Мониторинг и диагностика производительности

**User Story:** Как администратор системы, я хочу видеть метрики производительности оптимизированной системы для контроля качества работы

#### Acceptance Criteria

1. WHEN система использует параллельные воркеры THEN она SHALL логировать метрики времени выполнения каждого воркера
2. WHEN система делает запросы к AI THEN она SHALL отслеживать использование токенов и время ответа
3. WHEN система выбирает стратегию обработки THEN она SHALL логировать причины выбора и параметры
4. WHEN происходят ошибки THEN система SHALL предоставлять детальную диагностику для каждого компонента
5. WHEN система завершает обработку THEN она SHALL предоставлять сводные метрики производительности

### Requirement 6: Обратная совместимость

**User Story:** Как пользователь существующей системы, я хочу продолжать использовать те же команды и получать результаты в том же формате

#### Acceptance Criteria

1. WHEN пользователь вызывает команду суммаризации THEN интерфейс SHALL остаться неизменным
2. WHEN система возвращает результат THEN формат ответа SHALL соответствовать текущему
3. WHEN происходят ошибки THEN сообщения об ошибках SHALL быть понятными пользователю
4. WHEN система не может использовать оптимизированный режим THEN она SHALL автоматически переключаться на базовый режим
5. WHEN система обновляется THEN существующие конфигурации SHALL продолжать работать

### Requirement 7: Отказоустойчивость оптимизированной системы

**User Story:** Как пользователь, я хочу получать результат даже при частичных сбоях в оптимизированной системе

#### Acceptance Criteria

1. WHEN часть параллельных воркеров падает THEN система SHALL продолжать работу с оставшимися воркерами
2. WHEN AI провайдер возвращает ошибку на промежуточном этапе THEN система SHALL попытаться использовать альтернативную стратегию
3. WHEN система не может использовать оптимизированный режим THEN она SHALL автоматически переключиться на базовый режим
4. WHEN происходят критические ошибки THEN система SHALL предоставить пользователю максимально полезную информацию
5. WHEN система восстанавливается после ошибки THEN она SHALL логировать детали для последующего анализа