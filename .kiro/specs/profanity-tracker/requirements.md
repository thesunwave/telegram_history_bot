# Requirements Document

## Introduction

Данная функция предназначена для отслеживания и подсчета использования обсценной лексики (мата) пользователями в Telegram чатах. Система будет анализировать сообщения, выявлять матерные слова и ведет статистику по каждому пользователю, позволяя создавать рейтинги "самых матершинных" участников чата.

## Requirements

### Requirement 1

**User Story:** Как администратор чата, я хочу видеть топ пользователей по использованию мата, чтобы понимать кто больше всего ругается в чате.

#### Acceptance Criteria

1. WHEN пользователь отправляет команду `/profanity_top` THEN система SHALL показать топ-5 пользователей по количеству матерных слов за сегодня
2. WHEN пользователь отправляет команду `/profanity_top <n>` THEN система SHALL показать топ N пользователей (максимум 20)
3. WHEN пользователь отправляет команду `/profanity_top <n> <period>` THEN система SHALL показать топ за указанный период (today, week, month)
4. WHEN в чате нет данных о мате THEN система SHALL отобразить сообщение "Нет данных о матерной лексике"

### Requirement 2

**User Story:** Как пользователь чата, я хочу видеть статистику использования мата по дням, чтобы отслеживать динамику "матерности" чата.

#### Acceptance Criteria

1. WHEN пользователь отправляет команду `/profanity_chart_week` THEN система SHALL показать график использования мата за неделю
2. WHEN пользователь отправляет команду `/profanity_chart_month` THEN система SHALL показать график использования мата за месяц
3. WHEN система создает график THEN она SHALL использовать QuickChart API для генерации изображения
4. WHEN данных недостаточно THEN система SHALL показать текстовый график с ASCII символами

### Requirement 3

**User Story:** Как разработчик системы, я хочу использовать нейросеть для детекции матерной лексики, чтобы получить более точное и гибкое определение обсценных выражений без необходимости поддерживать словари.

#### Acceptance Criteria

1. WHEN система анализирует сообщение THEN она SHALL отправить текст на анализ в AI провайдер
2. WHEN AI провайдер определяет матерные слова THEN система SHALL получить список найденных слов с их базовыми формами
3. WHEN найдены матерные слова THEN система SHALL увеличить счетчик пользователя на количество найденных слов
4. WHEN система отправляет запрос к AI THEN она SHALL использовать существующую инфраструктуру провайдеров (OpenAI/Cloudflare)
5. IF AI провайдер недоступен THEN система SHALL логировать ошибку и продолжить работу без анализа мата
6. WHEN система получает ответ от AI THEN она SHALL кэшировать результат для одинаковых сообщений

### Requirement 4

**User Story:** Как администратор чата, я хочу иметь возможность сбросить статистику мата, чтобы начать подсчет заново.

#### Acceptance Criteria

1. WHEN пользователь отправляет команду `/profanity_reset` THEN система SHALL удалить всю статистику мата для текущего чата
2. WHEN сброс выполнен THEN система SHALL отправить подтверждающее сообщение
3. WHEN выполняется общий сброс `/reset` THEN статистика мата SHALL также быть сброшена

### Requirement 5

**User Story:** Как пользователь, я хочу видеть свою личную статистику использования мата, чтобы контролировать свою речь.

#### Acceptance Criteria

1. WHEN пользователь отправляет команду `/my_profanity` THEN система SHALL показать его статистику за сегодня, неделю и месяц
2. WHEN пользователь отправляет команду `/my_profanity <period>` THEN система SHALL показать статистику за указанный период
3. WHEN у пользователя нет статистики THEN система SHALL показать сообщение "У вас чистая речь!"

### Requirement 6

**User Story:** Как разработчик, я хочу чтобы система была производительной и не замедляла обработку сообщений.

#### Acceptance Criteria

1. WHEN система анализирует сообщение THEN обработка SHALL занимать не более 50ms
2. WHEN система сохраняет статистику THEN она SHALL использовать существующую инфраструктуру счетчиков
3. WHEN система проверяет мат THEN она SHALL использовать эффективные алгоритмы поиска
4. WHEN система обрабатывает большие сообщения THEN она SHALL ограничивать анализ первыми 1000 символами

### Requirement 7

**User Story:** Как администратор системы, я хочу иметь логирование работы детектора мата для отладки и мониторинга.

#### Acceptance Criteria

1. WHEN система находит матерное слово THEN она SHALL записать в лог информацию о событии (без самого слова)
2. WHEN происходит ошибка в детекторе THEN система SHALL записать подробную информацию об ошибке
3. WHEN система обновляет счетчики мата THEN она SHALL логировать успешные операции
4. IF включен debug режим THEN система SHALL логировать дополнительную информацию о процессе анализа

### Requirement 8

**User Story:** Как пользователь чата, я хочу видеть топ самых популярных матерных слов в чате, чтобы понимать какие именно выражения используются чаще всего.

#### Acceptance Criteria

1. WHEN пользователь отправляет команду `/profanity_words` THEN система SHALL показать топ-10 самых популярных матерных слов за сегодня
2. WHEN пользователь отправляет команду `/profanity_words <n>` THEN система SHALL показать топ N слов (максимум 20)
3. WHEN пользователь отправляет команду `/profanity_words <n> <period>` THEN система SHALL показать топ за указанный период
4. WHEN система группирует слова THEN она SHALL считать однокоренные и производные формы как одно слово
5. WHEN система отображает результат THEN она SHALL показывать базовую форму слова и количество использований
6. WHEN система отображает слова THEN она SHALL цензурировать их (заменять часть букв на звездочки)

### Requirement 9

**User Story:** Как пользователь, я хочу чтобы система работала с русским языком и корректно определяла мат с помощью AI.

#### Acceptance Criteria

1. WHEN система отправляет запрос к AI THEN она SHALL использовать промпт на русском языке для анализа текста
2. WHEN AI анализирует текст THEN он SHALL учитывать контекст и различать мат от обычных слов
3. WHEN AI находит мат THEN он SHALL возвращать базовые формы слов для корректной группировки
4. WHEN система получает ответ от AI THEN она SHALL корректно парсить JSON с найденными словами
5. IF AI не может определить язык THEN система SHALL указать в промпте что текст на русском языке